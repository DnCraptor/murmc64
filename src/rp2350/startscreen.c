/*
 * startscreen.c - Welcome/start screen for murmfrodo4
 *
 * Displays system information on startup before emulation begins.
 */

#include <stdio.h>
#include <string.h>
#include "board_config.h"
#include "startscreen.h"
#include "pico/stdlib.h"

// HDMI driver functions
extern uint8_t* graphics_get_buffer(void);

// Screen dimensions
#define SCREEN_WIDTH   FB_WIDTH
#define SCREEN_HEIGHT  FB_HEIGHT

// UI dimensions
#define UI_PADDING     6
#define CHAR_WIDTH     6
#define CHAR_HEIGHT    8
#define HEADER_HEIGHT  12
#define LINE_HEIGHT    10

// Colors (C64 palette indices)
#define COLOR_BG        6   // Blue (C64 blue background)
#define COLOR_BORDER    14  // Light Blue
#define COLOR_TEXT      1   // White
#define COLOR_HEADER_BG 14  // Light Blue (header background)
#define COLOR_HEADER_FG 0   // Black (header foreground)
#define COLOR_GREEN     5   // Green (for version/status)
#define COLOR_YELLOW    7   // Yellow

// Compact 6x8 bitmap font (same as disk_ui.c)
static const uint8_t font_6x8[][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // 32 Space
    {0x20,0x20,0x20,0x20,0x20,0x00,0x20,0x00}, // 33 !
    {0x50,0x50,0x50,0x00,0x00,0x00,0x00,0x00}, // 34 "
    {0x50,0x50,0xF8,0x50,0xF8,0x50,0x50,0x00}, // 35 #
    {0x20,0x78,0xA0,0x70,0x28,0xF0,0x20,0x00}, // 36 $
    {0xC0,0xC8,0x10,0x20,0x40,0x98,0x18,0x00}, // 37 %
    {0x40,0xA0,0xA0,0x40,0xA8,0x90,0x68,0x00}, // 38 &
    {0x20,0x20,0x40,0x00,0x00,0x00,0x00,0x00}, // 39 '
    {0x10,0x20,0x40,0x40,0x40,0x20,0x10,0x00}, // 40 (
    {0x40,0x20,0x10,0x10,0x10,0x20,0x40,0x00}, // 41 )
    {0x00,0x20,0xA8,0x70,0xA8,0x20,0x00,0x00}, // 42 *
    {0x00,0x20,0x20,0xF8,0x20,0x20,0x00,0x00}, // 43 +
    {0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x40}, // 44 ,
    {0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00}, // 45 -
    {0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00}, // 46 .
    {0x00,0x08,0x10,0x20,0x40,0x80,0x00,0x00}, // 47 /
    {0x70,0x88,0x98,0xA8,0xC8,0x88,0x70,0x00}, // 48 0
    {0x20,0x60,0x20,0x20,0x20,0x20,0x70,0x00}, // 49 1
    {0x70,0x88,0x08,0x30,0x40,0x80,0xF8,0x00}, // 50 2
    {0x70,0x88,0x08,0x30,0x08,0x88,0x70,0x00}, // 51 3
    {0x10,0x30,0x50,0x90,0xF8,0x10,0x10,0x00}, // 52 4
    {0xF8,0x80,0xF0,0x08,0x08,0x88,0x70,0x00}, // 53 5
    {0x30,0x40,0x80,0xF0,0x88,0x88,0x70,0x00}, // 54 6
    {0xF8,0x08,0x10,0x20,0x40,0x40,0x40,0x00}, // 55 7
    {0x70,0x88,0x88,0x70,0x88,0x88,0x70,0x00}, // 56 8
    {0x70,0x88,0x88,0x78,0x08,0x10,0x60,0x00}, // 57 9
    {0x00,0x00,0x20,0x00,0x00,0x20,0x00,0x00}, // 58 :
    {0x00,0x00,0x20,0x00,0x00,0x20,0x20,0x40}, // 59 ;
    {0x08,0x10,0x20,0x40,0x20,0x10,0x08,0x00}, // 60 <
    {0x00,0x00,0xF8,0x00,0xF8,0x00,0x00,0x00}, // 61 =
    {0x40,0x20,0x10,0x08,0x10,0x20,0x40,0x00}, // 62 >
    {0x70,0x88,0x10,0x20,0x20,0x00,0x20,0x00}, // 63 ?
    {0x70,0x88,0xB8,0xA8,0xB8,0x80,0x70,0x00}, // 64 @
    {0x70,0x88,0x88,0xF8,0x88,0x88,0x88,0x00}, // 65 A
    {0xF0,0x88,0x88,0xF0,0x88,0x88,0xF0,0x00}, // 66 B
    {0x70,0x88,0x80,0x80,0x80,0x88,0x70,0x00}, // 67 C
    {0xE0,0x90,0x88,0x88,0x88,0x90,0xE0,0x00}, // 68 D
    {0xF8,0x80,0x80,0xF0,0x80,0x80,0xF8,0x00}, // 69 E
    {0xF8,0x80,0x80,0xF0,0x80,0x80,0x80,0x00}, // 70 F
    {0x70,0x88,0x80,0xB8,0x88,0x88,0x70,0x00}, // 71 G
    {0x88,0x88,0x88,0xF8,0x88,0x88,0x88,0x00}, // 72 H
    {0x70,0x20,0x20,0x20,0x20,0x20,0x70,0x00}, // 73 I
    {0x38,0x10,0x10,0x10,0x90,0x90,0x60,0x00}, // 74 J
    {0x88,0x90,0xA0,0xC0,0xA0,0x90,0x88,0x00}, // 75 K
    {0x80,0x80,0x80,0x80,0x80,0x80,0xF8,0x00}, // 76 L
    {0x88,0xD8,0xA8,0xA8,0x88,0x88,0x88,0x00}, // 77 M
    {0x88,0xC8,0xA8,0x98,0x88,0x88,0x88,0x00}, // 78 N
    {0x70,0x88,0x88,0x88,0x88,0x88,0x70,0x00}, // 79 O
    {0xF0,0x88,0x88,0xF0,0x80,0x80,0x80,0x00}, // 80 P
    {0x70,0x88,0x88,0x88,0xA8,0x90,0x68,0x00}, // 81 Q
    {0xF0,0x88,0x88,0xF0,0xA0,0x90,0x88,0x00}, // 82 R
    {0x70,0x88,0x80,0x70,0x08,0x88,0x70,0x00}, // 83 S
    {0xF8,0x20,0x20,0x20,0x20,0x20,0x20,0x00}, // 84 T
    {0x88,0x88,0x88,0x88,0x88,0x88,0x70,0x00}, // 85 U
    {0x88,0x88,0x88,0x88,0x50,0x50,0x20,0x00}, // 86 V
    {0x88,0x88,0x88,0xA8,0xA8,0xD8,0x88,0x00}, // 87 W
    {0x88,0x88,0x50,0x20,0x50,0x88,0x88,0x00}, // 88 X
    {0x88,0x88,0x50,0x20,0x20,0x20,0x20,0x00}, // 89 Y
    {0xF8,0x08,0x10,0x20,0x40,0x80,0xF8,0x00}, // 90 Z
    {0x70,0x40,0x40,0x40,0x40,0x40,0x70,0x00}, // 91 [
    {0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x00}, // 92 backslash
    {0x70,0x10,0x10,0x10,0x10,0x10,0x70,0x00}, // 93 ]
    {0x20,0x50,0x88,0x00,0x00,0x00,0x00,0x00}, // 94 ^
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8}, // 95 _
    {0x40,0x20,0x10,0x00,0x00,0x00,0x00,0x00}, // 96 `
    {0x00,0x00,0x70,0x08,0x78,0x88,0x78,0x00}, // 97 a
    {0x80,0x80,0xB0,0xC8,0x88,0xC8,0xB0,0x00}, // 98 b
    {0x00,0x00,0x70,0x80,0x80,0x88,0x70,0x00}, // 99 c
    {0x08,0x08,0x68,0x98,0x88,0x98,0x68,0x00}, // 100 d
    {0x00,0x00,0x70,0x88,0xF8,0x80,0x70,0x00}, // 101 e
    {0x30,0x48,0x40,0xE0,0x40,0x40,0x40,0x00}, // 102 f
    {0x00,0x00,0x68,0x98,0x98,0x68,0x08,0x70}, // 103 g
    {0x80,0x80,0xB0,0xC8,0x88,0x88,0x88,0x00}, // 104 h
    {0x20,0x00,0x60,0x20,0x20,0x20,0x70,0x00}, // 105 i
    {0x10,0x00,0x30,0x10,0x10,0x90,0x60,0x00}, // 106 j
    {0x80,0x80,0x90,0xA0,0xC0,0xA0,0x90,0x00}, // 107 k
    {0x60,0x20,0x20,0x20,0x20,0x20,0x70,0x00}, // 108 l
    {0x00,0x00,0xD0,0xA8,0xA8,0xA8,0xA8,0x00}, // 109 m
    {0x00,0x00,0xB0,0xC8,0x88,0x88,0x88,0x00}, // 110 n
    {0x00,0x00,0x70,0x88,0x88,0x88,0x70,0x00}, // 111 o
    {0x00,0x00,0xB0,0xC8,0xC8,0xB0,0x80,0x80}, // 112 p
    {0x00,0x00,0x68,0x98,0x98,0x68,0x08,0x08}, // 113 q
    {0x00,0x00,0xB0,0xC8,0x80,0x80,0x80,0x00}, // 114 r
    {0x00,0x00,0x78,0x80,0x70,0x08,0xF0,0x00}, // 115 s
    {0x40,0x40,0xE0,0x40,0x40,0x48,0x30,0x00}, // 116 t
    {0x00,0x00,0x88,0x88,0x88,0x98,0x68,0x00}, // 117 u
    {0x00,0x00,0x88,0x88,0x88,0x50,0x20,0x00}, // 118 v
    {0x00,0x00,0x88,0xA8,0xA8,0xA8,0x50,0x00}, // 119 w
    {0x00,0x00,0x88,0x50,0x20,0x50,0x88,0x00}, // 120 x
    {0x00,0x00,0x88,0x88,0x98,0x68,0x08,0x70}, // 121 y
    {0x00,0x00,0xF8,0x10,0x20,0x40,0xF8,0x00}, // 122 z
    {0x10,0x20,0x20,0x40,0x20,0x20,0x10,0x00}, // 123 {
    {0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x00}, // 124 |
    {0x40,0x20,0x20,0x10,0x20,0x20,0x40,0x00}, // 125 }
    {0x00,0x00,0x40,0xA8,0x10,0x00,0x00,0x00}, // 126 ~
};

// Draw a filled rectangle
static void draw_rect(uint8_t *fb, int x, int y, int w, int h, uint8_t color) {
    for (int dy = 0; dy < h; dy++) {
        if (y + dy < 0 || y + dy >= SCREEN_HEIGHT) continue;
        for (int dx = 0; dx < w; dx++) {
            if (x + dx < 0 || x + dx >= SCREEN_WIDTH) continue;
            fb[(y + dy) * SCREEN_WIDTH + (x + dx)] = color;
        }
    }
}

// Draw a character using the 6x8 bitmap font
static void draw_char(uint8_t *fb, int x, int y, char c, uint8_t color) {
    int idx = (unsigned char)c - 32;
    if (idx < 0 || idx > 94) return;

    const uint8_t *glyph = font_6x8[idx];

    for (int row = 0; row < 8; row++) {
        if (y + row < 0 || y + row >= SCREEN_HEIGHT) continue;
        uint8_t bits = glyph[row];
        for (int col = 0; col < 6; col++) {
            if (x + col < 0 || x + col >= SCREEN_WIDTH) continue;
            if (bits & (0x80 >> col)) {
                fb[(y + row) * SCREEN_WIDTH + (x + col)] = color;
            }
        }
    }
}

// Draw a string
static void draw_string(uint8_t *fb, int x, int y, const char *str, uint8_t color) {
    while (*str) {
        draw_char(fb, x, y, *str, color);
        x += CHAR_WIDTH;
        str++;
    }
}

// Get string width in pixels
static int string_width(const char *str) {
    return strlen(str) * CHAR_WIDTH;
}

// Draw a centered string
static void draw_centered_string(uint8_t *fb, int y, const char *str, uint8_t color) {
    int w = string_width(str);
    int x = (SCREEN_WIDTH - w) / 2;
    draw_string(fb, x, y, str, color);
}

// Draw border
static void draw_border(uint8_t *fb, int x, int y, int w, int h) {
    draw_rect(fb, x, y, w, 1, COLOR_BORDER);
    draw_rect(fb, x, y + h - 1, w, 1, COLOR_BORDER);
    draw_rect(fb, x, y, 1, h, COLOR_BORDER);
    draw_rect(fb, x + w - 1, y, 1, h, COLOR_BORDER);
}

// Draw header bar (inverted colors)
static void draw_header(uint8_t *fb, int x, int y, int w, const char *title) {
    draw_rect(fb, x, y, w, HEADER_HEIGHT, COLOR_HEADER_BG);
    int title_len = strlen(title);
    int title_x = x + (w - title_len * CHAR_WIDTH) / 2;
    int title_y = y + (HEADER_HEIGHT - CHAR_HEIGHT) / 2;
    draw_string(fb, title_x, title_y, title, COLOR_HEADER_FG);
}

int startscreen_show(startscreen_info_t *info) {
    // Get framebuffer from HDMI driver
    uint8_t *buffer = graphics_get_buffer();
    if (!buffer) return -1;

    // Clear to C64 blue background
    memset(buffer, COLOR_BG, SCREEN_WIDTH * SCREEN_HEIGHT);

    // Window dimensions (centered)
    const int win_w = 220;
    const int win_h = 150;
    const int win_x = (SCREEN_WIDTH - win_w) / 2;
    const int win_y = (SCREEN_HEIGHT - win_h) / 2;

    // Draw window background and border
    draw_rect(buffer, win_x, win_y, win_w, win_h, COLOR_BG);
    draw_border(buffer, win_x, win_y, win_w, win_h);

    // Draw header with title
    draw_header(buffer, win_x + 1, win_y + 1, win_w - 2, info->title);

    // Content area starts after header
    int content_y = win_y + HEADER_HEIGHT + UI_PADDING + 4;

    // Subtitle
    draw_centered_string(buffer, content_y, info->subtitle, COLOR_TEXT);
    content_y += LINE_HEIGHT + 4;

    // Version (in green)
    draw_centered_string(buffer, content_y, info->version, COLOR_GREEN);
    content_y += LINE_HEIGHT + 10;

    // System information
    char line[48];

    snprintf(line, sizeof(line), "CPU: %lu MHz", (unsigned long)info->cpu_mhz);
    draw_centered_string(buffer, content_y, line, COLOR_TEXT);
    content_y += LINE_HEIGHT + 2;

    snprintf(line, sizeof(line), "PSRAM: %lu MHz", (unsigned long)info->psram_mhz);
    draw_centered_string(buffer, content_y, line, COLOR_TEXT);
    content_y += LINE_HEIGHT + 2;

    snprintf(line, sizeof(line), "Board: M%d", info->board_variant);
    draw_centered_string(buffer, content_y, line, COLOR_TEXT);
    content_y += LINE_HEIGHT + 10;

    // Copyright
    draw_centered_string(buffer, content_y, "By Mikhail Matveev", COLOR_TEXT);
    content_y += LINE_HEIGHT;
    draw_centered_string(buffer, content_y, "rh1.tech", COLOR_TEXT);

    // "Starting..." status at bottom (in yellow)
    content_y = win_y + win_h - LINE_HEIGHT - 6;
    draw_centered_string(buffer, content_y, "Starting...", COLOR_YELLOW);

    // Show for 6 seconds
    sleep_ms(6000);

    return 0;
}
